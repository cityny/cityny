name: Repo List Generator
on:
  schedule:
    - cron: '0 0 * * *' # Se ejecuta cada 24 horas
  workflow_dispatch: # Permite ejecuci贸n manual

jobs:
  repo-list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get Repo List Data
        id: repo_data
        uses: yi-Xu-0100/repo-list-generator@v1.1.1
        with:
          user: cityny
          my_token: ${{ secrets.REPO_TOKEN }}
          max_page: 1
          allow_empty: true
          allow_archived: true
          block_list: ""

      # Debug: Imprimir TODAS las salidas de la acci贸n
      - name: Debug - Mostrar salidas de la acci贸n
        run: |
          echo "Salida repoList_ALL: ${{ steps.repo_data.outputs.repoList_ALL }}"
          echo "Salida repoList: ${{ steps.repo_data.outputs.repoList }}"
          echo "Salida repoList_own: ${{ steps.repo_data.outputs.repoList_own }}"
          echo "Salida repoList_fork: ${{ steps.repo_data.outputs.repoList_fork }}"

      - name: Write to README using Python
        shell: python
        run: |
          import os

          # Debug: Imprimir el contenido del README antes de modificarlo
          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()
              print("Contenido actual del README (primeras 500 caracteres):")
              print(content[:500])

          # Debug: Imprimir la lista de repositorios recibida
          repo_list = """${{ steps.repo_data.outputs.repoList_ALL }}"""
          print("Lista de repositorios recibida (primeros 500 caracteres):")
          print(repo_list[:500])

          # Resto del c贸digo...
          start_tag = "--inicio--"
          end_tag = "--final--"

          if start_tag in content and end_tag in content:
              try:
                  pre = content.split(start_tag)[0]
                  post = content.split(end_tag)[1]
                  clean_list = repo_list.strip()
                  new_content = f"{pre}{start_tag}\n{clean_list}\n{end_tag}{post}"

                  # Debug: Imprimir el nuevo contenido del README
                  print("Nuevo contenido del README (primeros 500 caracteres):")
                  print(new_content[:500])

                  with open("README.md", "w", encoding="utf-8") as f:
                      f.write(new_content)
                  print("README.md actualizado con la lista ALL correctamente.")
              except Exception as e:
                  print(f"Error procesando el contenido: {e}")
                  exit(1)
          else:
              print(f"Error: No se encontraron las etiquetas '{start_tag}' y '{end_tag}' en el README.")
              exit(1)

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --cached README.md  # Debug: Mostrar cambios antes de commitear
          git commit -m " Actualizaci贸n autom谩tica de proyectos (incluye forks)" || echo "Nada que actualizar"
          git push
