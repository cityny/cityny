name: Repo List Generator
on:
  schedule:
    - cron: '0 0 * * *' # Se ejecuta cada 24 horas
  workflow_dispatch: # Permite ejecuci√≥n manual

jobs:
  repo-list:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get Repo List Data
        id: repo_data
        uses: yi-Xu-0100/repo-list-generator@v1.1.1
        with:
          user: cityny
          my_token: ${{ secrets.REPO_TOKEN }}
          max_page: 1
          allow_empty: true
          allow_archived: true
          block_list: ""

      - name: Write to README using Python
        shell: python
        run: |
          import os
          
          # CAMBIO CLAVE: Usamos repoList_ALL para capturar forks y proyectos propios
          repo_list = """${{ steps.repo_data.outputs.repoList_ALL }}"""
          
          if not os.path.exists("README.md"):
              print("El archivo README.md no existe.")
              exit(1)
              
          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()
          
          start_tag = "--inicio--"
          end_tag = "--final--"
          
          if start_tag in content and end_tag in content:
              try:
                  pre = content.split(start_tag)[0]
                  post = content.split(end_tag)[1]
                  
                  # Limpiamos espacios innecesarios de la lista generada
                  clean_list = repo_list.strip()
                  
                  # Reconstrucci√≥n del archivo
                  new_content = f"{pre}{start_tag}\n{clean_list}\n{end_tag}{post}"
                  
                  with open("README.md", "w", encoding="utf-8") as f:
                      f.write(new_content)
                  print("README.md actualizado con la lista ALL correctamente.")
              except Exception as e:
                  print(f"Error procesando el contenido: {e}")
                  exit(1)
          else:
              print(f"Error: No se encontraron las etiquetas '{start_tag}' y '{end_tag}' en el README.")
              exit(1)

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ü§ñ Actualizaci√≥n autom√°tica de proyectos (incluye forks)" || echo "Nada que actualizar"
          git push
