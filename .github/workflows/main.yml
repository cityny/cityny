# =============================================
# Workflow: Repo List Generator
# Descripci贸n: Genera autom谩ticamente una lista de repositorios (propios, forks y con estrella) y estad铆sticas para el perfil de GitHub de 'cityny'.
# Se ejecuta diariamente y tambi茅n puede ser activado manualmente.
# =============================================

name: Repo List Generator

# =============================================
# Eventos que disparan el workflow
# =============================================
on:
  schedule:
    - cron: '0 0 * * *'  # Ejecuci贸n diaria a medianoche (UTC)
  workflow_dispatch:      # Permite ejecuci贸n manual desde la interfaz de GitHub

# =============================================
# Definici贸n del trabajo principal
# =============================================
jobs:
  repo-list:
    runs-on: ubuntu-latest  # Sistema operativo para ejecutar el trabajo

    # =============================================
    # Pasos del trabajo
    # =============================================
    steps:
      # ---------------------------------------------
      # Paso 1: Clonar el repositorio
      # ---------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v3  # Clona el repositorio para acceder a los archivos

      # ---------------------------------------------
      # Paso 2: Generar im谩genes de estad铆sticas del perfil
      # ---------------------------------------------
      - name: Generate Stats Images
        uses: lowlighter/metrics@latest  # Genera una imagen con estad铆sticas del perfil de GitHub
        with:
          token: ${{ secrets.REPO_TOKEN }}  # Token de autenticaci贸n para acceder a la API de GitHub
          user: cityny  # Usuario de GitHub para el que se generan las estad铆sticas
          template: classic  # Plantilla para el dise帽o de la imagen
          base: header, activity, community, repositories, metadata  # Secciones de la imagen
          config_timezone: America/Caracas  # Zona horaria para las estad铆sticas
          filename: generated/stats.svg  # Ruta donde se guarda la imagen generada

      # ---------------------------------------------
      # Paso 3: Instalar jq (procesador de JSON)
      # ---------------------------------------------
      - name: Install jq
        run: sudo apt-get install -y jq  # Instala jq para procesar datos JSON de la API

      # ---------------------------------------------
      # Paso 4: Obtener datos de repositorios desde la API de GitHub
      # ---------------------------------------------
      - name: Get Repo List Data (API Directa)
        id: repo_data  # Identificador para usar los datos en pasos posteriores
        run: |
          # Obtiene la lista completa de repositorios del usuario (incluyendo forks)
          REPO_LIST=$(curl -s -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            "https://api.github.com/users/cityny/repos?per_page=100&type=all")

          # Obtiene la lista de repositorios marcados con estrella por el usuario
          STARRED_REPOS=$(curl -s -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            "https://api.github.com/users/cityny/starred?per_page=100")

          # Filtra los repositorios propios (no forks) y los convierte en una lista separada por comas
          OWN_REPOS=$(echo "$REPO_LIST" | jq -r '.[] | select(.fork == false) | .full_name' | tr '\n' ',')

          # Filtra los repositorios con fork y los convierte en una lista separada por comas
          FORK_REPOS=$(echo "$REPO_LIST" | jq -r '.[] | select(.fork == true) | .full_name' | tr '\n' ',')

          # Convierte la lista de repositorios con estrella en una lista separada por comas
          STARRED_REPOS_LIST=$(echo "$STARRED_REPOS" | jq -r '.[].full_name' | tr '\n' ',')

          # Guarda los datos en variables de salida para usarlos en el siguiente paso
          echo "ownRepos=$OWN_REPOS" >> $GITHUB_OUTPUT
          echo "forkRepos=$FORK_REPOS" >> $GITHUB_OUTPUT
          echo "starredRepos=$STARRED_REPOS_LIST" >> $GITHUB_OUTPUT
        shell: bash

      # ---------------------------------------------
      # Paso 5: Actualizar el README.md con los datos obtenidos
      # ---------------------------------------------
      - name: Write to README using Python
        shell: python
        run: |
          import os

          # Etiquetas EXACTAS para identificar las secciones en el README.md
          # (Se usan para reemplazar el contenido entre estas etiquetas)
          stats_start = "<!-- inicio-stats-->"  # Inicio de la secci贸n de estad铆sticas
          stats_end   = "<!-- final-stats-->"    # Fin de la secci贸n de estad铆sticas

          own_start   = "<!-- inicio-proyectos -->"  # Inicio de la secci贸n de repositorios propios
          own_end     = "<!-- final-proyectos -->"    # Fin de la secci贸n de repositorios propios

          fork_start  = "<!-- inicio-forks -->"      # Inicio de la secci贸n de repositorios con fork
          fork_end    = "<!-- final-forks -->"        # Fin de la secci贸n de repositorios con fork

          star_start  = "<!-- inicio-stars -->"      # Inicio de la secci贸n de repositorios con estrella
          star_end    = "<!-- final-stars -->"        # Fin de la secci贸n de repositorios con estrella

          # Cargar datos de los pasos anteriores (variables generadas en el paso 4)
          own_repos = "${{ steps.repo_data.outputs.ownRepos }}"      # Repositorios propios
          fork_repos = "${{ steps.repo_data.outputs.forkRepos }}"    # Repositorios con fork
          starred_repos = "${{ steps.repo_data.outputs.starredRepos }}"  # Repositorios con estrella

          # Lee el contenido actual del README.md
          with open("README.md", "r", encoding="utf-8") as f:
              content = f.read()

          # Funci贸n para actualizar una secci贸n del README (entre etiquetas)
          def update_section(text, start, end, new_content):
              if start in text and end in text:
                  pre = text.split(start)[0]
                  post = text.split(end)[1]
                  return f"{pre}{start}\n{new_content}\n{end}{post}"
              return text

          # Funci贸n para formatear la lista de repositorios como enlaces de Markdown
          def format_repos(repo_list):
              repo_names = sorted(repo_list.split(',')) if repo_list else []
              return "\n".join(f"- [{r.split('/')[1]}](https://github.com/{r})" for r in repo_names if r).strip()

          # Actualiza cada secci贸n del README con los datos correspondientes
          content = update_section(content, own_start, own_end, format_repos(own_repos))      # Repositorios propios
          content = update_section(content, fork_start, fork_end, format_repos(fork_repos))  # Repositorios con fork
          content = update_section(content, star_start, star_end, format_repos(starred_repos))  # Repositorios con estrella

          # Inyecta la imagen de estad铆sticas en su secci贸n correspondiente
          stats_img = '<img src="./generated/stats.svg" />'
          content = update_section(content, stats_start, stats_end, stats_img)

          # Escribe el contenido actualizado de vuelta al README.md
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(content)

      # ---------------------------------------------
      # Paso 6: Confirmar y subir cambios al repositorio
      # ---------------------------------------------
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"  # Configura el email de Git
          git config --local user.name "GitHub Action"       # Configura el nombre de usuario de Git
          git pull origin main  # Asegura que el repositorio local est茅 actualizado
          git add README.md generated/  # A帽ade los archivos modificados/creados
          git commit -m " Stats y Repos actualizados sin errores" || echo "Nada que actualizar"  # Confirma los cambios
          git push origin main  # Sube los cambios al repositorio remoto
